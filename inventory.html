<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventaire</title>
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="inventory-page">

  <header>
    <nav class="top-nav">
      <a href="index.html">ğŸ  Home</a>
      <a href="viz.html">ğŸŒ Interactive Visualizations</a>
      <a href="inventory.html" class="active">ğŸ“ Inventory</a>
      <a href="comparateur.html">ğŸ“Š Comparison</a>
      <a href="basket.html">ğŸ›’ Basket</a>
    </nav>
  </header>

  <main class="main-content">
    <h1>ğŸ“ Dataset Inventory</h1>

    <section class="search-panel">
      <div class="form-row">
        <label for="layerSelect">ğŸ” Level :</label>
        <select id="layerSelect">
          <option value="2">Main Categories</option>
          <option value="3">Sub-Categories</option>
          <option value="4">Products</option>
        </select>
      </div>

      <div class="search-container">
        <input type="text" id="searchBox" placeholder="Search for a product..." autocomplete="off" />
        <ul id="dropdownList" class="dropdown" style="display: none;"></ul>
      </div>
    </section>

    <section class="results-panel">
      <div class="results" id="results"></div>
    </section>
  </main>

  <script>

    function getEmoji(name) {
      const emojiMap = {
        oil: "ğŸ›¢ï¸",
        pesto : "ğŸƒ",
        plant: "ğŸŒ±",
        eggplant: "ğŸ†",
        pumpkin: "ğŸƒ",
        pasta: "ğŸ",
        cookie: "ğŸª",
        chocolate: "ğŸ«",
        spinach: "ğŸ¥¬",
        zucchini: "ğŸ¥’",
        beef: "ğŸ¥©",
        lamb: "ğŸ¥©",
        pork: "ğŸ¥©",
        date: "ğŸŒ´",
        raisin:"ğŸ‡",
        apricot: "ğŸ‘",
        berry: "ğŸ«",
        currant: "ğŸ«",
        bacon: "ğŸ¥“",
        kiwi: "ğŸ¥",
        chicken: "ğŸ—",
        poultry: "ğŸ—",
        egg: "ğŸ¥š",
        milk: "ğŸ¥›",
        cream: "ğŸ¶",
        "dairy products": "ğŸ¶",
        mascarpone: "ğŸ¶",
        mozzarella: "ğŸ§€",
        "parmigiano reggiano" : "ğŸ§€",
        seed: "ğŸŒ±",
        sunflower: "ğŸŒ»",
        chilly: "ğŸŒ¶ï¸",
        ricotta: "ğŸ§€",
        stracchino: "ğŸ§€",
        mealworm: "ğŸª±",
        tangerin: "ğŸŠ",
        mandarin: "ğŸŠ",
        olive: "ğŸ«’",
        pineapple: "ğŸ",
        barley: "ğŸŒ¾",
        flour: "ğŸŒ¾",
        grains: "ğŸŒ¾",
        millet: "ğŸŒ¾",
        oat: "ğŸŒ¾",
        rye: "ğŸŒ¾",
        sorghum: "ğŸŒ¾",
        wheat: "ğŸŒ¾",
        beans: "ğŸ«˜",
        chickpea: "ğŸ«˜",
        cowpea: "ğŸ«˜",
        lentil:"ğŸ«˜",
        soybean: "ğŸ«˜",
        chestnut: "ğŸŒ°",
        hazelnut: "ğŸŒ°",
        "mixed nut": "ğŸŒ°",
        "palm nut": "ğŸŒ°",
        pistachio:"ğŸŒ°",
        burger: "ğŸ”",
        peanut:"ğŸ¥œ",
        maize: "ğŸŒ½",
        clementine: "ğŸŠ",
        cheese: "ğŸ§€",
        yogurt: "ğŸ¶",
        butter: "ğŸ§ˆ",
        margarine: "ğŸ§ˆ",
        fish: "ğŸŸ",
        salmon: "ğŸŸ",
        trout: "ğŸŸ",
        turbot: "ğŸŸ",
        carp: "ğŸŸ",
        cod: "ğŸŸ",
        apple: "ğŸ",
        banana: "ğŸŒ",
        orange: "ğŸŠ",
        lemon: "ğŸ‹",
        lime: "ğŸ‹",
        mango: "ğŸ¥­",
        pear: "ğŸ",
        peach: "ğŸ‘",
        plum: "ğŸ‘",
        pineapple: "ğŸ",
        grape: "ğŸ‡",
        strawberry: "ğŸ“",
        raspberry: "ğŸ“",
        blueberry: "ğŸ«",
        raspberry: "ğŸ«",
        avocado: "ğŸ¥‘",
        tomato: "ğŸ…",
        ketchup: "ğŸ…",
        cucumber: "ğŸ¥’",
        carrot: "ğŸ¥•",
        corn: "ğŸŒ½",
        "sweet potato": "ğŸ ",
        cabbage: "ğŸ¥¬",
        cauliflower: "ğŸ¥¦",
        potato: "ğŸ¥”",
        onion: "ğŸ§…",
        garlic: "ğŸ§„",
        broccoli: "ğŸ¥¦",
        lettuce: "ğŸ¥¬",
        bread: "ğŸ",
        cake: "ğŸ°",
        croissant: "ğŸ¥",
        wine: "ğŸ·",
        beer: "ğŸº",
        juice: "ğŸ§ƒ",
        coffee: "â˜•",
        sugar: "ğŸ¬",
        pepper: "ğŸŒ¶ï¸",
        ginger: "ğŸ«š",
        watermelon: "ğŸ‰",
        fruit: "ğŸ",
        legumes: "ğŸŒ±",
        nuts: "ğŸŒ°",
        spicies: "ğŸŒ¶ï¸",
        tubers : "ğŸ¥”",
        vegetables : "ğŸ¥¦",
        biscuits : "ğŸª",
        drinks: "ğŸ¹",
        vegetal: "ğŸŒ±",
        animal: "ğŸ®",
        "processed food": "ğŸ•",
        crops: "ğŸŒ¾"
      };

      const key = Object.keys(emojiMap).find(k => name.toLowerCase().includes(k));
      return emojiMap[key] || "ğŸ½ï¸";
    }


    function flattenByLevel(node, level, currentLevel = 1, result = []) {
      if (currentLevel === level) {
        result.push({ name: node.name, value: node.value });
      } else if (node.children) {
        node.children.forEach(child => flattenByLevel(child, level, currentLevel + 1, result));
      }
      return result;
    }

    let carbonRoot = null;
    let waterRoot = null;
    let currentList = [];

    Promise.all([
      d3.json("data/data_carbon.json"),
      d3.json("data/data_water.json")
    ]).then(([carbon, water]) => {
      carbonRoot = carbon;
      waterRoot = water;
      updateList();
    });

    document.getElementById("layerSelect").addEventListener("change", updateList);
    document.getElementById("searchBox").addEventListener("input", filterDropdown);
    document.getElementById("searchBox").addEventListener("focus", () => {
      if (currentList.length > 0) {
        filterDropdown();
      }
    });
    document.addEventListener("click", (e) => {
      const container = document.querySelector(".search-container");
      if (!container.contains(e.target)) {
        document.getElementById("dropdownList").style.display = "none";
      }
    });

    function updateList() {
      const level = +document.getElementById("layerSelect").value;
      currentList = flattenByLevel(carbonRoot, level);
      filterDropdown();
      document.getElementById("dropdownList").style.display = "none";
    }

    function filterDropdown() {
      const query = document.getElementById("searchBox").value.toLowerCase();
      const filtered = currentList.filter(d => d.name.toLowerCase().includes(query));
      const dropdown = document.getElementById("dropdownList");

      dropdown.innerHTML = "";

      if (filtered.length === 0) {
        dropdown.style.display = "none";
        return;
      }

      filtered.forEach(d => {
        const li = document.createElement("li");
        li.textContent = d.name;
        li.addEventListener("click", () => {
          document.getElementById("searchBox").value = d.name;
          dropdown.style.display = "none";
          showDetails(d.name);
        });
        dropdown.appendChild(li);
      });

      dropdown.style.display = "block";
    }

    function showDetails(name) {
      const carbonMatch = findByName(carbonRoot, name);
      const waterMatch = findByName(waterRoot, name);

      const maxCarbon = getMaxValue(carbonRoot);
      const maxWater = getMaxValue(waterRoot);

      const resultDiv = document.getElementById("results");
      let html = `<div class="result-name">${getEmoji(name)} ${name}</div><div style="margin-bottom: 1rem;"></div>`;

      if (carbonMatch) {
        const carbonPct = Math.round((carbonMatch.value / maxCarbon) * 100);
        html += `
          <div class="result-item">
            <span class="highlight">ğŸŒ Carbon:</span> ${carbonMatch.value} kg COâ‚‚
            <div class="impact-bar">
              <div class="bar carbon-bar" style="width: ${carbonPct}%"></div>
            </div>
          </div>`;
      }

      if (waterMatch) {
        const waterPct = Math.round((waterMatch.value / maxWater) * 100);
        html += `
          <div class="result-item">
            <span class="highlight">ğŸ’§ Water:</span> ${waterMatch.value} L
            <div class="impact-bar">
              <div class="bar water-bar" style="width: ${waterPct}%"></div>
            </div>
          </div>`;
      }

      resultDiv.innerHTML = html;
    }

    function getMaxValue(node) {
      let max = node.value || 0;
      if (node.children) {
        node.children.forEach(child => {
          max = Math.max(max, getMaxValue(child));
        });
      }
      return max;
    }

    function findByName(node, name) {
      if (node.name === name) return node;
      if (node.children) {
        for (const child of node.children) {
          const found = findByName(child, name);
          if (found) return found;
        }
      }
      return null;
    }
  </script>

</body>
</html>
